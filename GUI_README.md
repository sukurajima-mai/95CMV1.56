# 传奇2自动挂机脚本 - 图形界面版本

## 新功能

### 1. 图形界面
- 提供友好的图形界面，无需命令行操作
- 实时显示运行日志
- 一键启动、暂停、停止
- 窗口检测测试功能

### 2. 自动跟随窗口移动
- 每次检测前自动更新窗口位置
- 窗口移动后自动调整检测区域
- 无需手动重启脚本

### 3. 窗口被遮挡时仍能检测
- 使用 Win32 API 进行截图
- 即使窗口被其他窗口覆盖也能正常捕获画面
- 不需要窗口在前台

## 使用方法

### 启动图形界面

双击运行 `start_gui.bat` 或者在命令行中运行：
```bash
python mir2_bot_gui.py
```

### 界面操作

1. **启动按钮**
   - 点击启动挂机脚本
   - 自动查找游戏窗口
   - 开始检测目标文字

2. **暂停/恢复按钮**
   - 暂停：暂停检测，但不停止脚本
   - 恢复：继续检测
   - 方便临时中断

3. **停止按钮**
   - 完全停止挂机脚本
   - 显示最终统计信息

4. **测试窗口检测按钮**
   - 测试是否能找到游戏窗口
   - 显示窗口信息和位置

### 日志说明

- **黑色文字**：普通信息
- **橙色文字**：警告信息
- **红色文字**：错误信息

## 技术改进

### 1. 窗口跟随移动

```python
# 每次截图前重新获取窗口位置
self.window_rect = win32gui.GetWindowRect(self.hwnd)
```

### 2. 被遮挡时仍能检测

使用 Win32 API 的 `BitBlt` 函数直接从窗口设备上下文截图：

```python
# 获取窗口设备上下文
hwndDC = win32gui.GetWindowDC(self.hwnd)
mfcDC = win32ui.CreateDCFromHandle(hwndDC)
saveDC = mfcDC.CreateCompatibleDC()

# 创建位图对象
saveBitMap = win32ui.CreateBitmap()
saveBitMap.CreateCompatibleBitmap(mfcDC, width, height)
saveDC.SelectObject(saveBitMap)

# 截图（即使窗口被遮挡也能截取）
result = saveDC.BitBlt((0, 0), (width, height), mfcDC, (0, 0), win32con.SRCCOPY)
```

### 3. 线程安全

- 挂机脚本在独立线程中运行
- GUI 线程不被阻塞
- 日志输出线程安全

## 依赖要求

除了原有的依赖外，图形界面版本需要：

- ✅ tkinter (Python 标准库，通常已包含)
- ✅ win32ui (pywin32 的一部分，已安装)

## 注意事项

1. **窗口标题**
   - 默认查找标题包含"九五沉默"的窗口
   - 可在 `bot_config.ini` 中修改 `window_title`

2. **检测间隔**
   - 建议设置在 0.3-0.5 秒之间
   - 太短会占用过多 CPU
   - 太长会降低响应速度

3. **传送冷却**
   - 默认 4 秒
   - 可根据需要调整
   - 避免频繁传送被封号

4. **Tesseract OCR**
   - 必须安装 Tesseract OCR 引擎
   - 必须安装中文简体语言包 (chi_sim)
   - 必须添加到系统 PATH 环境变量

## 常见问题

### 1. 图形界面打不开
- 检查 Python 是否安装
- 检查 tkinter 是否可用（`import tkinter`）
- 检查依赖包是否安装

### 2. 窗口检测失败
- 确保游戏窗口已打开
- 检查窗口标题是否匹配
- 使用"测试窗口检测"按钮测试

### 3. 检测不到目标文字
- 检查 Tesseract OCR 是否安装
- 检查中文语言包是否安装
- 检查 PATH 环境变量
- 启用调试模式查看详情

### 4. 窗口移动后检测失效
- 新版本已修复此问题
- 每次检测前自动更新窗口位置
- 无需手动重启

### 5. 窗口被遮挡时检测失败
- 新版本已修复此问题
- 使用 Win32 API 直接截图
- 不需要窗口在前台

## 文件说明

- `mir2_bot_gui.py` - 图形界面主程序
- `start_gui.bat` - 图形界面启动脚本
- `mir2_auto_bot.py` - 命令行版本（保留）
- `bot_config.ini` - 配置文件（共享）

## 更新日志

### v3.1 - 图形界面版本 (2026-02-13)

**新增功能**：
- ✅ 添加图形界面
- ✅ 自动跟随窗口移动
- ✅ 窗口被遮挡时仍能检测
- ✅ 暂停/恢复功能
- ✅ 窗口检测测试功能
- ✅ 实时日志显示

**技术改进**：
- 使用 Win32 API 进行截图
- 线程安全的日志输出
- 每次检测前更新窗口位置
- 支持窗口被遮挡时检测

**文件新增**：
- `mir2_bot_gui.py` - 图形界面程序
- `start_gui.bat` - 启动脚本
- `GUI_README.md` - 本文档

## 使用建议

1. **首次使用**
   - 运行 `start_gui.bat` 启动图形界面
   - 点击"测试窗口检测"确认能找到游戏窗口
   - 点击"启动"开始挂机

2. **日常使用**
   - 双击 `start_gui.bat` 启动
   - 点击"启动"开始挂机
   - 需要暂停时点击"暂停"
   - 完成后点击"停止"

3. **调试问题**
   - 启用调试模式（在 `bot_config.ini` 中设置 `debug = true`）
   - 查看 `debug/` 目录下的调试图像
   - 使用"测试窗口检测"按钮测试窗口检测
